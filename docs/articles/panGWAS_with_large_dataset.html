<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>panGWAS_with_large_dataset • aurora</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="panGWAS_with_large_dataset">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">aurora</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/get_bags.html">get_bags</a></li>
    <li><a class="dropdown-item" href="../articles/outputs.html">outputs</a></li>
    <li><a class="dropdown-item" href="../articles/panGWAS.html">panGWAS</a></li>
    <li><a class="dropdown-item" href="../articles/panGWAS_with_large_dataset.html">panGWAS_with_large_dataset</a></li>
    <li><a class="dropdown-item" href="../articles/setup_conda.html">setup_conda</a></li>
    <li><a class="dropdown-item" href="../articles/SNP_and_kmer_GWAS.html">SNP_and_kmer_GWAS</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/DalimilBujdos/aurora/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>panGWAS_with_large_dataset</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DalimilBujdos/aurora/blob/HEAD/vignettes/panGWAS_with_large_dataset.Rmd" class="external-link"><code>vignettes/panGWAS_with_large_dataset.Rmd</code></a></small>
      <div class="d-none name"><code>panGWAS_with_large_dataset.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this vignette we will look how to optimize <em>aurora</em> for a
large dataset. <em>aurora</em> builds hundreds training datasets and
corresponding machine learning models. Thus especially large and
versatile datasets with many features may not finish in a reasonable
time. On the other hand, since <em>aurora</em> is not parallelized it
has low CPU and RAM requirements. If the user has the option, we advise
to run <em>aurora</em> in the background as the vast majority of
datasets with over 500 strains may take a few days to finish. It is
always advised to run <em>aurora</em> with the most accurate settings
and all machine learning tools but the even the core version will
provide good results.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DalimilBujdos/aurora" class="external-link">aurora</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/KlausVigo/phangorn" class="external-link">phangorn</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="workflow">Workflow<a class="anchor" aria-label="anchor" href="#workflow"></a>
</h2>
<p>Let’s first simulate some data. We will use <em>Limosilactobacillus
reuteri</em> dataset which will be bootstrapped to obtain a larger
dataset.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"pheno_mat_reuteri"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"bin_mat_reuteri"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bootstrap the dataset to make it larger</span></span>
<span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pheno_mat</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2000</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">pheno_mat</span> <span class="op">&lt;-</span> <span class="va">pheno_mat</span><span class="op">[</span><span class="va">index</span>, <span class="op">]</span></span>
<span><span class="va">bin_mat_tmp</span> <span class="op">&lt;-</span> <span class="va">bin_mat</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="op">-</span><span class="fl">14</span><span class="op">]</span></span>
<span><span class="va">bin_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">bin_mat</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">14</span><span class="op">]</span>, <span class="va">bin_mat_tmp</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">pheno_mat</span><span class="op">$</span><span class="va">ids</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">bin_mat_tmp</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># give the strains generic names because the indexes must be unique</span></span>
<span><span class="va">pheno_mat</span><span class="op">$</span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"strain"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pheno_mat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">bin_mat</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="op">-</span><span class="fl">14</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"strain"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pheno_mat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Create a random tree</span></span>
<span><span class="va">tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ape/man/rtree.html" class="external-link">rtree</a></span><span class="op">(</span><span class="fl">2000</span>, tip.label <span class="op">=</span> <span class="va">pheno_mat</span><span class="op">$</span><span class="va">ids</span><span class="op">)</span></span></code></pre></div>
<p>With such a large dataset you could apply algorithms that reduce the
number of strains while still preserving maximum variability. For
example <a href="https://bmcbioinformatics.biomedcentral.com/articles/10.1186/s12859-018-2164-8" class="external-link">Treemmer</a>,
<a href="https://pubmed.ncbi.nlm.nih.gov/23587045/" class="external-link">Treetrimmer</a> and
<a href="https://pubmed.ncbi.nlm.nih.gov/21306634/" class="external-link">Tree Pruner</a> can
all do this. While this is a good option especially when the dataset
contains clonal lineages, it is difficult to know what is still an
acceptable reduction. Additionally, due to horizontal gene transfer
there variability is present even in clonal lineages. In the
<em>aurora</em> paper we show that some clonal lineages of <em>S.</em>
Typhimurium contain strains isolated from multiple habitats. Reducing
the amount of strains thus may lead to a significant loss of
information.</p>
<p>Instead of removing strains you can configure <em>aurora</em> to do
just a fraction of the computation thus lowering the computational time.
If you are sure that your dataset does not contain any mislabelled
strains and you are sure that the species is adapted to the phenotype,
then you do not have to run the computationally exhausting
<code><a href="../reference/aurora_pheno.html">aurora_pheno()</a></code> function and just run the GWAS analysis with
<code><a href="../reference/aurora_GWAS.html">aurora_GWAS()</a></code>. Runnig this function should take just a few
minutes</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run GWAS analysis without results from aurora_pheno()</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aurora_GWAS.html">aurora_GWAS</a></span><span class="op">(</span>bin_mat <span class="op">=</span> <span class="va">bin_mat</span>,</span>
<span>                   pheno_mat <span class="op">=</span> <span class="va">pheno_mat</span>,</span>
<span>                   tree <span class="op">=</span> <span class="fu"><a href="https://klausvigo.github.io/phangorn/reference/midpoint.html" class="external-link">midpoint</a></span><span class="op">(</span><span class="va">tree</span><span class="op">)</span>,</span>
<span>                   write_data <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Finished</span></span></code></pre></div>
<p>See vignette <code>panGWAS</code> to see how to postprocess the GWAS
results.</p>
<p>However, what if you want to run <code><a href="../reference/aurora_pheno.html">aurora_pheno()</a></code>. What is
the best parameter setting for a large dataset? This depends on the
properties of your data. The simplest way to reduce the computational
time is to decrease the parameter <code>no_rounds</code> from the
default 100 to 50. Going even lower is not recommended as this could
result in lowering the statistical power to detect adaptation to the
phenotype. If the genes responsible for the adaptation have high effect
size then the intervention will not influence the results however if
multiple low effect size genes are responsible for the adaptation and if
only a small fraction of the strains is adapted to the phenotype then
<code>no_rounds</code> should be kept at 100. Another way to decrease
the computational time is to omit some machine learning algorithms. In
the <em>aurora</em> article we have demonstrated that using multiple
algorithms may be redundant as they all tend to identify the same
strains as mislabelled. Random Forest and CART models produce a distance
matrix. These matrices are crucial for analysing genotype-phenotype
associations and for identifying more mislabelled strains. Thus we will
disable the two remaining algorithms: log regression
(<code>ovr_log_reg = FALSE</code>) and AdaBoost
(<code>adaboost = FALSE</code>) to retain only the two most informative
models. This will reduce the computational time almost twofold.</p>
<p>Another way to lower the computational time is to reduce the number
of strains in the training dataset. You can do so by modifying the
argument <code>bag_size</code>. By default <code>bag_size</code> is set
to 5* the number of strains in the class with the fewest strains. Hence,
if you have 60 strains in class A, 30 strains in class B and 80 strains
in class C the training dataset will contain 150 strains from each
class. We can lower this by setting the parameter <code>bag_size</code>
to <code>bag_size = c(75,75,75)</code>. This way of reducing the
computational time is suitable in cases where the dataset contains
roughly the same number of strains in each class. Sometimes fitting
parameters to AdaBoost and Random Forest takes a long time. This fitting
can be disabled by setting <code>fit_parameters</code> to
<code>FALSE</code>. To find the best parameters
<code>fit_parameters</code> runs <a href="https://machinelearningmastery.com/hyperparameter-optimization-with-random-search-and-grid-search/" class="external-link">grid
search algorithm</a>. Due to the stochastic nature of the bagging
algorithmns, the parameter fitting needs to be repeated multiple times
(default: 10). You can reduce the number of repetitions by setting
<code>repeats = 5</code>. Alternatively, more experienced users can
utilize function <code><a href="../reference/get_bags.html">get_bags()</a></code> to build their own training
datasets and optimize hyperparameters (see vignette
<code>get_bags</code>). These hyperparameters can then be passed to
<code><a href="../reference/aurora_pheno.html">aurora_pheno()</a></code> (see <code>?aurora_pheno()</code>
documentation). Lastly, the choice of bagging algorithm also influence
the computational time. <code>phylogenetic_walk</code> takes roughly 100
times more CPU time than <code>random_walk</code>. However, since most
of the computational time is spent on fitting the models this changes
will not influence the overall computational time as much. We advise
using <code>random_walk</code> only when an accurate phylogenetic tree
could not be obtained or in cases where a large portion of the dataset
is mislabelled. Let’s demonstrate how we can assess what parameters we
can change to reduce the computational time.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot the phyogenetic tree first to see if the dataset is clonal</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tree</span>, type <span class="op">=</span> <span class="st">"fan"</span>, show.tip.label <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># Thy phylogenetic tree does not appear to contain large clonal lineages that we could collapse into a single strain. Let's thus look at other ways to reduce the computational time</span></span>
<span></span>
<span><span class="co"># If one class in the dataset is not dominant them we could reduce the argument bag_size</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">pheno_mat</span><span class="op">$</span><span class="va">pheno</span><span class="op">)</span></span>
<span><span class="co"># While rodent and poultry isolates are clearly more abundant the numbers are roughly equal and we can reduce bag_size</span></span>
<span><span class="va">table_tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">pheno_mat</span><span class="op">$</span><span class="va">pheno</span><span class="op">)</span></span>
<span><span class="va">bag_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">table_tmp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="va">table_tmp</span><span class="op">)</span><span class="op">]</span><span class="op">*</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">table_tmp</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Another thing that will drastically reduce the computational time is lowering the number of classes. The results then has to be interpreted accordingly.</span></span>
<span><span class="va">pheno_mat</span><span class="op">$</span><span class="va">pheno</span><span class="op">[</span><span class="va">pheno_mat</span><span class="op">$</span><span class="va">pheno</span> <span class="op">!=</span> <span class="st">"rodent"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"other"</span> <span class="co"># make only two classes: rodent and other</span></span>
<span></span>
<span><span class="fu"><a href="../reference/aurora_pheno.html">aurora_pheno</a></span><span class="op">(</span>pheno_mat <span class="op">=</span> <span class="va">pheno_mat</span>,</span>
<span>             bin_mat <span class="op">=</span> <span class="va">bin_mat</span>,</span>
<span>             type_bin_mat <span class="op">=</span> <span class="st">"custom"</span>,</span>
<span>             tree <span class="op">=</span> <span class="va">tree</span>,</span>
<span>             bag_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">bag_size</span><span class="op">)</span>,</span>
<span>             bagging <span class="op">=</span> <span class="st">"random_walk"</span>, <span class="co"># use random walk which is faster than phylogenetic walk</span></span>
<span>             repeats <span class="op">=</span> <span class="fl">5</span>, <span class="co"># This will lower the time needed to fit hyperparameters to Random Forest</span></span>
<span>             ovr_log_reg <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># Do not use log regression</span></span>
<span>             adaboost <span class="op">=</span> <span class="cn">FALSE</span> , <span class="co"># Do not use AdaBoost</span></span>
<span>             no_rounds <span class="op">=</span> <span class="fl">50</span>, <span class="co"># From literature we know that reuteri colonization factors have high effect size. Therefore we can reduce this argument</span></span>
<span>             write_data <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Sometimes the number of strains is not limiting but the number of
features is (<em>i.e.,</em> when SNPs or k-mers are used as the
investigated variants). In this case, follow the vignette
<code>SNP_and_kmer_GWAS</code>. In the example above the pangenome has
many genes in the cloud genome and many genes near core genome. All of
these are certainly not causal. One simple way to filter the features
and subsequently lower the computational time is to increase the
parameter <code>low_perc_cutoff</code> from 3 to 5 which will removed
the cloud genes and decrease the parameter <code>upp_perc_cutoff</code>
from 99 to 95 which removes the near core genes.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Dalimil Bujdoš.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
